# Простой WEB Server на Си

Создаем серверный сокет.
![](img/1_создаем_серверный_сокет.png)

Объявляем и инициализируем нашу структуру __hints__.
![](img/2_создаем_структуру_hints.png)

![](img/3_инициализируем_структуру_hints.png)

Вызываем функцию __getaddrinfo(...)__ для преобразования доменного имени, имени хоста и IP-адреса из удобочитаеммого текстового представления в структурированный двоичный формат для сетевого API операционной системы.
![](img/4_getaddrinfo.png)

Создаем серверный сокет.
![](img/5_socket.png)

Связываем серверный сокет с адресом и портом, полученным из __getaddrinfo(...)__ с помощью __bind(...)__.
![](img/6_bind.png)

Возвращаем слушающий серверный сокет.
![](img/7_возвращаем_серверный_сокет.png)

Возвращаемся в цикл __while(1)__ и вызываем нашу функцию __wait_on_clients(...)__.
![](img/8_wait_on_clients.png)

В функции __wait_on_clients(...)__ создаем и обнуляем структуру __fd_set reads__. Заносим в __reads__ серверный сокет.
![](img/9_FD_ZERO.png)

Ранее была создана кастомная структура __client_info__ для хранения информации о каждом подключенном клиенте.
Также ранее была создана статическая глобальная переменная __clients__ с адресом равным нулю:
__static struct client_info *clients = 0;__
![](img/10_clients.png)

Функция __select(...)__ блокирует выполнение кода ожидая когда сработает сокет ранее записанный в структуру reads.
![](img/11_select.png)

Делаем запрос на __localhost:8080__.
![](img/12_запрос_клиента-браузер.png)

После того, как __wait_on_clients(...)__ вернула структуру __reads__, проверяем установлен ли сервереный сокет.
![](img/13_FD_ISSET_server.png)

Вызываем функцию __get_client(...)__ для создания списочной структуры под клиентский сокет.
![](img/14_get_client.png)

Выделяем памят под списочную структуру.
![](img/15_новый_адрес_под_структуру.png)

В поле __n->next__ устанавливается текущий корень глобального связанного списка, а для корня глобального связанного списка, __clients__, устанавливается значение __n__. 
![](img/16_новый_узел_для_данных_клиента.png)

Функция __accept(...)__ используется сервером для принятия связи на сокет.
![](img/17_accept.png)

Запускаем цикл __while(client)__, проходим по узлам связанного списка с данными клиентских сокетов, перебираем клиентов в цикле, ищем клиента чей сокет сработал в связанном списке __reads__, с помощью __FD_ISSET(client->socket, &reads)__, продвигаемся по узлам через __client->next__, при __client__ равным нулю выходим и снова попадаем в цикл __while(1)__.
![](img/18_while(client).png)

Первоначально сокет клиента в структуре типа __fd_set__ не установлен поэтому выходим из цикла __while(client)__, в функции __wait_on_client(...)__ заносим сокет клиента в структуру __fd_set reads__ через __FD_SET(ci->socket, &reads)__ и попадаем снова в цикл __while(1)__. Далее в функции __wait_on_clients(SOCKET server)__ каждый раз обнуляем связанный список __fd_set reads__ через __FD_ZERO(&reads)__ и заносим в __reads__ снова сокет сервера и новый сокет клиента для прослушки с помощью __select(...)__.
![](img/19_FD_SET_client.png)

![](img/20_select_client.png)

Через __r = recv(client->socket, ....)__ получаем данные запроса от клиента.
![](img/21_recv.png)

 Формируем строку запроса из массива символов полученных от клиента __client->request[client->received] = 0__. Например __"GET / HTTP/1.1\r\nHost: localhost:8080\r\nConnection: keep-alive\r\... "__
![](img/22_запрос_от_клиента.png)

Если запрашивается файл __index.html__.
![](img/23_path_index.html.png)

Открываем файл на чтение.
![](img/24_fopen.png)

Определяем размер файла.
![](img/25_content-length.png)

Определяем тип запрашиваемого ресурса.
![](img/26_get_content_type.png)

Отсылаем заголовки(содержимое буфера) __Content-Length, Content-Type__ клиенту.
![](img/27_отсылаем_заголовки_клиенту.png)

Читаем содержимое файла(часть файла размером __BSIZE__) через открытый дескриптор __fp__ в буфер и отсылаем чанками клиенту.
![](img/28_fread_send.png)

Закрываем дескрипторы открытых файлов, сокетов, освобождаем память.
![](img/29_fclose.png)

![](img/30_drop_client.png)

![](img/31_free_mem.png)

Снова попадаем в цикл __while(1)__ и снова с помощью __select__ ждем запросы от клиентов.
![](img/32_снова_while(1)_select.png)



